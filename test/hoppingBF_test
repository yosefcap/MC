using MonteCarlo
using Test, Plots, FFTW


#@testset DQMC.jl begin
m = HoppingBFModel(dims=2,L=10,J=1, h=0.2, α=0.,μ=0.)
mc=DQMC_bond(m,beta=5)
slices=  mc.p.slices
initialize_stack(mc) # redundant ?!
build_stack(mc)
propagate(mc)
calculate_greens(mc)
#=
function DQMC_bond_uniform(m::M; seed::Int=-1, kwargs...) where M<:Model

    p = DQMC_bondParameters(; kwargs...)
    geltype = greenseltype(DQMC_bond, m)
    conf = ones(2*m.L^m.dims, p.time_slices)
    mc = DQMC_bond{M, typeof(conf), DQMC_bondStack{geltype,Float64}}()
    mc.model = m
    mc.p = p
    mc.s = DQMC_bondStack{geltype,Float64}()
    mc.K_xy = m.J*p.delta_tau
    mc.K_tau = 0.5*log(coth(m.h*p.delta_tau))
    init!(mc, seed=seed, conf=conf)
    return mc
end
function init_uniform!(mc::DQMC_bond; seed::Real=-1, conf=ones(2*L^2,sl) )
    seed == -1 || Random.seed!(seed)

    mc.conf = conf
    mc.hopping_mat = init_hopping_matrices(mc, mc.model)
    init_diag_terms(mc, mc.model)
    initialize_stack(mc)
    mc.obs = prepare_observables(mc, mc.model)
    mc.a = DQMC_bondAnalysis()
    nothing
end
=#

#run!(mc, sweeps=10, thermalization=10, verbose=true);
#observables(mc) # what observables do exist for that simulation?
#m = mc.obs["m"] # magnetization
#mean(m)
#std(m) # one-sigma error
#greens = mc.obs["greens"]
#conf = mc.obs["confs"]
#histogram(conf)
#end

#heatmap(mc.s.greens)
LL=10

bond_ch = mc.model.bond_checkerboard
N=size(bond_ch,2)
HH=zeros(100,100)
for cb in 1:4
    for n in 1:N
        i = bond_ch[2,n,cb]
        j = bond_ch[3,n,cb]
        HH[i,j]=1
        HH[j,i]=1
    end
end

gg=reshape(mc.s.greens,(LL,LL,LL,LL))
kk=fft(gg[:,:,1,1])

#kk=fft(gg)
heatmap(real(kk))
heatmap(imag(kk))
